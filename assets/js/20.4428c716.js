(window.webpackJsonp=window.webpackJsonp||[]).push([[20],{235:function(t,s,a){t.exports=a.p+"assets/img/require.a18d31d3.png"},236:function(t,s,a){t.exports=a.p+"assets/img/require.cache.81abb18a.png"},237:function(t,s,a){t.exports=a.p+"assets/img/module.require.c923b74a.png"},397:function(t,s,a){"use strict";a.r(s);var n=a(28),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"模块"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#模块"}},[t._v("#")]),t._v(" 模块")]),t._v(" "),n("p",[t._v("采用了 Commonjs 规范，通过 "),n("code",[t._v("module.exports、require")]),t._v(" 来导出和导入模块。模块加载机制中，采用了延迟加载的策略。就是说在用到的情况下，系统模块才会被加载，等加载完成后会放到 binding_cache 中。")]),t._v(" "),n("h2",{attrs:{id:"系统模块"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#系统模块"}},[t._v("#")]),t._v(" 系统模块")]),t._v(" "),n("ul",[n("li",[t._v("核心模块（native 模块），"),n("code",[t._v("http、buffer、fs")]),t._v(" 等，底层调用的内建模块 (C/C++)；")]),t._v(" "),n("li",[t._v("C/C++ 模块（built-in 内建模块），供 native 模块调用；")])]),t._v(" "),n("h2",{attrs:{id:"第三方模块"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#第三方模块"}},[t._v("#")]),t._v(" 第三方模块")]),t._v(" "),n("ul",[n("li",[t._v("第三方维护的模块，比如 "),n("code",[t._v("express、koa、moment.js")]),t._v(" 等；")]),t._v(" "),n("li",[t._v("本地维护的模块（以路径形式的文件模块）比如 "),n("code",[t._v(".")]),t._v("、"),n("code",[t._v("..")]),t._v("、"),n("code",[t._v("/")]),t._v(" 开头的;")])]),t._v(" "),n("h2",{attrs:{id:"文件形式"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#文件形式"}},[t._v("#")]),t._v(" 文件形式")]),t._v(" "),n("ul",[n("li",[t._v("javaScript 模块，"),n("code",[t._v("module.js")]),t._v("；")]),t._v(" "),n("li",[t._v("json 模块，"),n("code",[t._v("module.json")]),t._v("；")]),t._v(" "),n("li",[t._v("C/C++ 模块，编译后扩展名为 .node，"),n("code",[t._v("module.node")]),t._v("；")])]),t._v(" "),n("h2",{attrs:{id:"加载步骤"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#加载步骤"}},[t._v("#")]),t._v(" 加载步骤")]),t._v(" "),n("p",[t._v("经历 "),n("code",[t._v("路径分析")]),t._v("、"),n("code",[t._v("文件定位")]),t._v("和"),n("code",[t._v("编译执行")]),t._v("。")]),t._v(" "),n("h2",{attrs:{id:"加载顺序"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#加载顺序"}},[t._v("#")]),t._v(" 加载顺序")]),t._v(" "),n("ul",[n("li",[t._v("系统缓存，一个模块被执行后会被缓存起来，提高再次加载速度；")]),t._v(" "),n("li",[t._v("系统模块，即原生模块，部分核心模块已经被编译成二进制，省略了 "),n("code",[t._v("路径分析、文件定位")]),t._v("，会直接被加载到了内存中，其中系统模块定义在源码的 lib 目录下；")]),t._v(" "),n("li",[t._v("文件模块，优先加载 "),n("code",[t._v(".、..、/")]),t._v(" 开头的，会依次按照 "),n("code",[t._v(".js、.json、.node")]),t._v(" 进行扩展名补足尝试（文件没有加上扩展名），最好还是加上文件的扩展名。")]),t._v(" "),n("li",[t._v("目录模块，文件模块加载过程中，没有找到，但发现一个同样的目录名，就会将这个目录当作一个"),n("strong",[t._v("包")]),t._v("来处理。这块采用了 Commonjs 规范，在文件 "),n("code",[t._v("package.json")]),t._v(" 中查找；")]),t._v(" "),n("li",[t._v("node_module 模块，如果系统模块、路径文件模块都找不到，Node.js 会从当前模块的父目录开始查找，直到系统的根目录；")])]),t._v(" "),n("p",[n("img",{attrs:{src:a(235),alt:"加载顺序"}})]),t._v(" "),n("h2",{attrs:{id:"关于缓存问题"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#关于缓存问题"}},[t._v("#")]),t._v(" 关于缓存问题")]),t._v(" "),n("p",[t._v("模块缓存后，可以通过 "),n("code",[t._v("require.cache")]),t._v(" 查看已缓存的模块。")]),t._v(" "),n("div",{staticClass:"language-javascript extra-class"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 模块文件 require.module.js")]),t._v("\nmodule"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exports "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    name"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'pr'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("say")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("div",{staticClass:"language-javascript extra-class"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 引用模块文件 require.cache.js")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./require.module'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nconsole"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'require.cache ----- '")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nconsole"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("require"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cache"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("p",[n("img",{attrs:{src:a(236),alt:""}})]),t._v(" "),n("h2",{attrs:{id:"对象引用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#对象引用"}},[t._v("#")]),t._v(" 对象引用")]),t._v(" "),n("p",[t._v("1.exports 与 module.exports 关系")]),t._v(" "),n("div",{staticClass:"language-javascript extra-class"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" exports "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("  module"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exports"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("p",[t._v("所以就不能改变 exports 的指向，可以这样")]),t._v(" "),n("div",{staticClass:"language-javascript extra-class"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[t._v("exports"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("info "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    name"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'pr'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    age"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("30")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\nmodule"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exports "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    name"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'pr'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    age"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("30")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("h2",{attrs:{id:"模块循环引用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#模块循环引用"}},[t._v("#")]),t._v(" 模块循环引用")]),t._v(" "),n("p",[t._v("模块 "),n("code",[t._v("moduleA.js")]),t._v(" 和 "),n("code",[t._v("moduleB.js")]),t._v(" 两个模块互相引用，会怎样？")]),t._v(" "),n("div",{staticClass:"language-javascript extra-class"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// moduleA.js")]),t._v("\nconsole"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'模块 moduleA'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nexports"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'moduleA name'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nage "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("27")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" moduleB "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./moduleB.js'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nconsole"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'moduleA require moduleB =>'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" moduleB"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("div",{staticClass:"language-javascript extra-class"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// moduleB.js")]),t._v("\nconsole"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'模块 moduleB'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nexports"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'moduleB name'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" moduleA "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./moduleA.js'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nconsole"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'moduleB require moduleA =>'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" moduleA"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("p",[n("img",{attrs:{src:a(237),alt:"模块循环引用"}})]),t._v(" "),n("ul",[n("li",[t._v("启动模块 "),n("code",[t._v("node moduleA.js")]),t._v("，会打印 "),n("code",[t._v("模块 moduleA")]),t._v("；")]),t._v(" "),n("li",[t._v("模块 "),n("code",[t._v("moduleA.js")]),t._v(" 中加载 "),n("code",[t._v("moduleB.js")]),t._v("，打印 "),n("code",[t._v("模块 moduleB")]),t._v("；")]),t._v(" "),n("li",[t._v("模块 "),n("code",[t._v("moduleB.js")]),t._v(" 中又加载 "),n("code",[t._v("moduleA.js")]),t._v("，此时模块 "),n("code",[t._v("moduleA.js")]),t._v(" 还没有执行完，返回模块 "),n("code",[t._v("moduleA.js")]),t._v(" 的 "),n("code",[t._v("exports")]),t._v(" 对象给到模块 "),n("code",[t._v("moduleB.js")]),t._v("；")]),t._v(" "),n("li",[t._v("模块 "),n("code",[t._v("moduleB.js")]),t._v(" 加载完后，其中有个 "),n("code",[t._v("moduleA.js")]),t._v(" 中挂载了全局的变量 "),n("code",[t._v("age")]),t._v("，所以能打印出来，最后将模块 "),n("code",[t._v("moduleB.js")]),t._v(" 的 "),n("code",[t._v("exports")]),t._v(" 对象给到模块 "),n("code",[t._v("moduleA.js")]),t._v("；")])]),t._v(" "),n("p",[t._v("很有意思的是，在代码执行前，会用一个封装器将执行代码段封装起来")]),t._v(" "),n("div",{staticClass:"language-javascript extra-class"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("exports"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" require"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" module"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" __filename"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" __dirname")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// something")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("p",[n("a",{attrs:{href:"https://github.com/ruizhengyun/nodejs-note/tree/master/notes/0.0.1",target:"_blank",rel:"noopener noreferrer"}},[t._v("本次代码 Github"),n("OutboundLink")],1)])])}),[],!1,null,null,null);s.default=e.exports}}]);